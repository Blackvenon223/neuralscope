"""Data repository: walks project files and scans each via LLM."""

from __future__ import annotations

from pathlib import Path

from neuralscope.features.vulnerability_scan.data.datasource.llm_scanner.implementation import (
    LlmSecurityScanner,
)
from neuralscope.features.vulnerability_scan.domain.entities.vulnerability import (
    Vulnerability,
    VulnReport,
)
from neuralscope.features.vulnerability_scan.domain.repository.scanner import (
    IScannerRepository,
)

SKIP_DIRS = {".venv", "venv", "__pycache__", ".git", "node_modules", ".tox"}


class ScannerRepository(IScannerRepository):
    def __init__(self, scanner: LlmSecurityScanner) -> None:
        self._scanner = scanner

    async def scan_project(self, project_path: str) -> VulnReport:
        root = Path(project_path)
        py_files = [f for f in root.rglob("*.py") if not self._skip(f, root)]

        all_vulns: list[Vulnerability] = []
        for f in py_files:
            try:
                source = f.read_text(encoding="utf-8")
                if len(source.strip()) == 0:
                    continue
                vulns = await self._scanner.scan_source(str(f.relative_to(root)), source)
                all_vulns.extend(vulns)
            except (OSError, UnicodeDecodeError):
                continue

        return VulnReport(
            project_path=project_path,
            vulnerabilities=all_vulns,
            summary=f"Scanned {len(py_files)} files, found {len(all_vulns)} issue(s)",
        )

    @staticmethod
    def _skip(path: Path, root: Path) -> bool:
        return bool(SKIP_DIRS & set(path.relative_to(root).parts))

"""Bandit static analysis datasource."""

from __future__ import annotations

import json
import subprocess

from neuralscope.core.logging import get_logger
from neuralscope.features.vulnerability_scan.domain.entities.vulnerability import (
    Vulnerability,
    VulnSeverity,
    VulnSource,
)

logger = get_logger("bandit_scanner")

SEVERITY_MAP = {
    "LOW": VulnSeverity.LOW,
    "MEDIUM": VulnSeverity.MEDIUM,
    "HIGH": VulnSeverity.HIGH,
}


class BanditScanner:
    async def scan(self, project_path: str) -> list[Vulnerability]:
        try:
            result = subprocess.run(
                ["bandit", "-r", project_path, "-f", "json", "-q"],
                capture_output=True,
                text=True,
                timeout=120,
            )
            # bandit exits 1 when issues found â€” not an error
            if result.stdout:
                return self._parse(result.stdout)
        except (FileNotFoundError, subprocess.TimeoutExpired) as exc:
            logger.warning("Bandit unavailable: %s", exc)
        return []

    def _parse(self, raw: str) -> list[Vulnerability]:
        try:
            data = json.loads(raw)
        except json.JSONDecodeError:
            return []

        vulns = []
        for finding in data.get("results", []):
            vulns.append(
                Vulnerability(
                    id=finding.get("test_id", ""),
                    title=finding.get("test_name", ""),
                    severity=SEVERITY_MAP.get(finding.get("issue_severity", ""), VulnSeverity.LOW),
                    source=VulnSource.BANDIT,
                    file_path=finding.get("filename", ""),
                    line=finding.get("line_number", 0),
                    description=finding.get("issue_text", ""),
                    cwe=str(finding.get("cwe", {}).get("id", "")),
                )
            )
        return vulns
